@page "/apartment-form"
@page "/apartments/add"
@page "/apartments/edit/{Id:int}"
@using TenantElectricityUI.Services
@using TenantElectricity.Shared.Models
@inject ApartmentService ApartmentService
@inject NavigationManager NavigationManager

<h3>@(Id == 0 ? "Add Apartment" : "Edit Apartment")</h3>

<EditForm Model="apartment" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Apartment Number</label>
        <InputText class="form-control" @bind-Value="apartment.ApartmentNumber" />
    </div>
    <div class="mb-3">
        <label class="form-label">Owner Name</label>
        <InputText class="form-control" @bind-Value="apartment.OwnerName" />
    </div>
    <div class="mb-3">
        <label class="form-label">Phone</label>
        <InputText class="form-control" @bind-Value="apartment.Phone" />
    </div>

    <button class="btn btn-primary" type="submit">Save</button>
    <button class="btn btn-secondary" type="button" @onclick="NavigateBack">Cancel</button>
</EditForm>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="text-danger">@errorMessage</p>
}

@code {
    [Parameter] public int Id { get; set; }
    private Apartment apartment = new();
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            try
            {
                apartment = await ApartmentService.GetApartmentByIdAsync(Id);
            }
            catch (Exception ex)
            {
                errorMessage = $"Failed to load apartment: {ex.Message}";
            }
        }
    }

    private async Task HandleSubmit()
    {
        if (Id == 0)
        {
            await ApartmentService.CreateApartmentAsync(apartment); // Verifica el modelo aquí
        }
        else
        {
            await ApartmentService.UpdateApartmentAsync(Id, apartment);
        }

        NavigationManager.NavigateTo("/apartments");
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/apartments");
    }
}
